---
/**
 * æ–‡ç« å¯†ç ä¿æŠ¤ç»„ä»¶
 * å½“æ–‡ç« è¢«è®¾ç½®ä¸ºåŠ å¯†æ—¶ï¼Œæ˜¾ç¤ºå¯†ç è¾“å…¥ç•Œé¢
 */
interface Props {
  slug: string;
  password: string;
  class?: string;
}

const { slug, password, class: className = '' } = Astro.props;
const formId = `password-form-${slug}`;
const contentId = `article-content-${slug}`;  // ä¸æ–‡ç« é¡µé¢ä¸­çš„å†…å®¹IDä¿æŒä¸€è‡´
const overlayId = `overlay-${slug}`;
---

<div id={overlayId} class={`password-protection-overlay ${className}`}>
  <div class="password-container card-base rounded-xl p-6 md:p-8 max-w-md w-full">
    <h3 class="font-bold text-xl mb-4">ğŸ”’ æ­¤å†…å®¹å·²åŠ å¯†</h3>
    <p class="mb-6 text-black/70 dark:text-white/70">è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å®Œæ•´å†…å®¹</p>
    <form id={formId} class="flex flex-col">
      <input 
        type="password" 
        class="form-input mb-4 p-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white/90 dark:bg-[#1a1a1a] w-full focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" 
        placeholder="è¯·è¾“å…¥å¯†ç " 
        required
      />
      <button 
        type="submit" 
        class="btn-primary rounded-md py-2 px-4 text-white font-medium"
      >
        è§£é”å†…å®¹
      </button>
      <p id="error-message" class="text-red-500 mt-2 text-sm hidden">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
    </form>
  </div>
</div>

<style>
.password-protection-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--card-bg);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 20;
  backdrop-filter: blur(5px);
}

.password-container {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* æ·»åŠ æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
.hidden-overlay {
  animation: fadeOut 0.3s forwards;
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; visibility: hidden; }
}
</style>

<script define:vars={{ slug, password, formId, contentId, overlayId }}>
// æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦å·²ç»éªŒè¯è¿‡
// å•Šï¼Œæ­å–œä½ å‘ç°äº†å‰ç«¯åŠ å¯†çš„å°ç§˜å¯†ï¼
// æ²¡é”™ï¼Œè¿™ç§åŠ å¯†æ–¹å¼åªæ˜¯åœ¨å‰ç«¯éªŒè¯ï¼Œå¯†ç å°±æ˜æ–‡å†™åœ¨è¿™é‡Œ
// æ‰€ä»¥å¦‚æœä½ ç”¨å¼€å‘è€…å·¥å…·çœ‹åˆ°äº†è¿™æ®µä»£ç ï¼Œé‚£ä¹ˆä¸ç”¨è¾“å…¥å¯†ç ä¹Ÿèƒ½çœ‹åˆ°å†…å®¹äº†
// ä¸è¿‡è¯·ä¿å®ˆè¿™ä¸ªå°ç§˜å¯†å“¦ï¼Œæ¯•ç«Ÿè¿™åªæ˜¯ä¸ºäº†é˜²å›å­ä¸é˜²å°äººçš„æ¸©å’Œä¿æŠ¤ :)
// ä½ å¯ä»¥ç›´æ¥åœ¨localStorageä¸­æ·»åŠ  fuwari-unlocked-å¯¹åº”æ–‡ç« slug å¹¶è®¾ä¸ºtrueæ¥è·³è¿‡éªŒè¯
const storageKey = `fuwari-unlocked-${slug}`;
const isUnlocked = localStorage.getItem(storageKey) === 'true';

// å¦‚æœå·²è§£é”ï¼Œéšè—é®ç½©å¹¶æ˜¾ç¤ºå†…å®¹
if (isUnlocked) {
  document.getElementById(overlayId).classList.add('hidden-overlay');
  document.getElementById(contentId)?.classList.remove('hidden');
}

// è¡¨å•æäº¤å¤„ç†
document.getElementById(formId).addEventListener('submit', function(e) {
  e.preventDefault();
  
  // è·å–è¾“å…¥çš„å¯†ç 
  const inputPassword = e.target.querySelector('input[type="password"]').value;
  
  // éªŒè¯å¯†ç 
  if (inputPassword === password) {
    // å¯†ç æ­£ç¡®ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¹¶éšè—é®ç½©
    localStorage.setItem(storageKey, 'true');
    document.getElementById(overlayId).classList.add('hidden-overlay');
    // æ˜¾ç¤ºæ–‡ç« å†…å®¹
    document.getElementById(contentId)?.classList.remove('hidden');
  } else {
    // å¯†ç é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    document.getElementById('error-message').classList.remove('hidden');
  }
});
</script>
